# カスタムバイナリプロトコル仕様 v1.0

## メッセージタイプ (1 byte)

| 値 | タイプ | 説明 |
|----|--------|------|
| 0x01 | STATE | 通常状態更新（差分） |
| 0x02 | STATE_FULL | 状態更新 + 全テリトリー |
| 0x10 | INIT | 初期接続データ |
| 0x20 | PLAYER_DEATH | プレイヤー死亡 |
| 0x30 | ROUND_START | ラウンド開始 |
| 0x31 | ROUND_END | ラウンド終了 |
| 0x40 | CHAT | チャットメッセージ |

---

## STATE メッセージ (0x01, 0x02)

```
[0]     : メッセージタイプ (0x01 or 0x02)
[1-2]   : 残り時間 (uint16, seconds)
[3]     : プレイヤー数
[4...]  : プレイヤーデータ配列

// 0x02の場合のみ追加:
[N]     : テリトリー数 (uint16)
[N+2...]: テリトリーデータ配列
```

### プレイヤーデータ (可変長)

```
[0]     : プレイヤーインデックス (0-255)
[1-2]   : X座標 (uint16)
[3-4]   : Y座標 (uint16)
[5]     : 色インデックス (0-255, パレット参照)
[6]     : 状態 (上位4bit: state, 下位4bit: invulnerable秒)
[7-8]   : スコア (uint16)
[9]     : trail長さ (0-255)
[10...] : trail座標 (各2bytes: x/10<<8 | y/10)
```

### テリトリーデータ (6 bytes/rect)

```
[0-1]   : X座標 (uint16, /GRID_SIZE)
[2-3]   : Y座標 (uint16, /GRID_SIZE)
[4]     : 幅 (uint8, /GRID_SIZE)
[5]     : 高さ (uint8, /GRID_SIZE)
[6]     : 色インデックス (uint8)
```

---

## INIT メッセージ (0x10)

```
[0]     : メッセージタイプ (0x10)
[1]     : 自分のプレイヤーインデックス
[2]     : 自分の色インデックス
[3-4]   : ワールド幅 (uint16)
[5-6]   : ワールド高さ (uint16)
[7]     : ゲームモード (0=SOLO, 1=TEAM)
[8]     : 障害物数
[9...]  : 障害物データ
[N]     : テリトリー数 (uint16)
[N+2...]: テリトリーデータ
[M]     : プレイヤー名/emoji/id マッピング数
[M+1...]: マッピングデータ
```

---

## 色パレット (256色)

インデックス0-17: プレイヤー基本色
インデックス18-255: 追加色（動的割り当て）

---

## サイズ比較

| データ | JSON | Binary | 削減率 |
|--------|------|--------|--------|
| 1プレイヤー | ~200 bytes | ~15 bytes | 92% |
| 16プレイヤー | ~3.2 KB | ~250 bytes | 92% |
| 1000テリトリー | ~50 KB | ~6 KB | 88% |
| フルメッセージ | ~8 KB | ~700 bytes | 91% |
