# Game Project Specification v5

**更新日:** 2026-01-06
**バージョン:** 5.0.0
**サーバー:** Node.js + WebSocket (ws) + HTTP/2 (https)
**クライアント:** HTML5 Canvas + WebSocket
**データベース:** MySQL (ランキング・統計用)

---

## 1. ディレクトリ構造

Version 5では、サーバーロジック、静的アセット、クライアントモジュールが以下のように構成されています。

```text
/game01/
├── server.v3.js          # メインゲームサーバー (Node.js - モノリス構成)
├── msgpack.js            # 共有ライブラリ (MsgPackエンコーダ/デコーダ)
├── public_html/          # 静的Webアセット (ドキュメントルート)
│   ├── index.html        # エントリーポイント
│   ├── style.css         # スタイルシート
│   ├── admin.html        # 管理画面
│   └── client/           # モジュール化されたクライアントJS
│       ├── client-config.js   # 設定・定数・グローバル状態
│       ├── client-network.js  # WebSocket通信・データ同期
│       ├── client-game.js     # ゲームループ・描画・入力
│       └── client-ui.js       # UI操作・イベントハンドラ
├── docs/                 # ドキュメント
├── sql/                  # データベース定義
└── bkup/                 # バックアップ
```

## 2. サーバーアーキテクチャ (`server.v3.js`)

### 2.1 静的ファイル配信
- `public_html/` ディレクトリ配下のファイルを配信する簡易HTTPサーバー機能を内蔵。
- 対応MIMEタイプ: html, css, js, json, png, jpg, mp3, mp4, etc.
- ディレクトリトラバーサル対策済み。
- CORS設定: `open2ch.net` サブドメインおよびローカルホストからのアクセスを許可。

### 2.2 WebSocketサーバー
- **ライブラリ:** `ws` (perMessageDeflate有効化により通信量を圧縮)
- **ポート:** 2053 (または 2087)
- **SSL:** 証明書が存在する場合はWSS、なければWSとして動作。
- **通信モード:** WebSocketのみ (Polling無効化によるパフォーマンス最適化)。

### 2.3 ゲームループ
- **ティックレート:** 可変 (負荷に応じて変動、基本60FPSターゲット)
- **ワールド:** グリッドベース (1セル = 10px)。
- **マップサイズ:** 参加人数に応じて動的に拡張 (`WORLD_WIDTH/HEIGHT` = 2000 + 人数*100)。
- **ロジック:**
  - **移動:** 速度ベクトルベース。クライアント入力は角度(0-254)。
  - **領地獲得:** フロードフィル（塗りつぶし）アルゴリズム。軌跡がループを作ると囲まれた領域を獲得。
  - **内部獲得:** 自分の領地や軌跡で囲まれた「敵の領地」や「空白地」も獲得対象。
  - **障害物:** グリッドに沿った矩形の障害物を生成。

### 2.4 APIエンドポイント (HTTP)
- `/api/rounds`: 最近のラウンド一覧 (フィルタ: `hours`, `limit`)
- `/api/round/:id`: 特定ラウンドの詳細統計（ランキング、ミニマップデータ）
- `/api/player-stats`: プレイヤー累計成績
- `/api/team-stats`: チーム累計成績
- `/api/server-stats`: サーバーパフォーマンス統計 (CPU, メモリ, 帯域, ラグ)
- `/api/server-realtime`: リアルタイムサーバー状態 (メモリ詳細, 稼働時間)
- `/api/admin/reset-rankings`: [POST] ランキングデータのリセット

## 3. クライアントアーキテクチャ (`public_html/client/*`)

クライアント機能は責務ごとに4つのモジュールに分割されています。

| ファイル | 責務 |
|------|----------------|
| **client-config.js** | 定数(`SERVER_URL`, `COLORS`)、グローバル変数(`players`, `world`)、ユーティリティ(`formatScore`) |
| **client-network.js** | WebSocket接続(`connect`)、メッセージルーティング(`onmessage`)、デシリアライズ(`MsgPack`, `Pako`)、状態同期 |
| **client-game.js** | メインループ(`loop`)、描画(`drawParticles`, `drawGrid`)、入力処理(バーチャルジョイスティック) |
| **client-ui.js** | HTML UI操作(`updateLeaderboard`, 画面遷移)、モーダル、チャット表示 |

## 4. 通信プロトコル

データ転送最適化のため、**MsgPack** と **カスタムバイナリ** を併用しています。

### 4.1 Client -> Server

| タイプ | フォーマット | 内容・備考 |
|------|--------|-------------|
| **Join** | MsgPack (JSON) | `{ type: 'join', name: '..', team: '..' }` |
| **Input** | **Binary (1 byte)** | `Uint8[0]`: 角度 (0-254)。 `255` = 停止。 |
| **Chat** | MsgPack (JSON) | `{ type: 'chat', text: '..' }` |
| **Team** | MsgPack (JSON) | `{ type: 'update_team', team: '..' }` |
| **Png** | MsgPack (JSON) | `{ type: 'png' }` (Ping計測用) |

### 4.2 Server -> Client (MsgPack)

| キー | 説明 | 内容詳細 |
|------|-------------|-------------------|
| `type` | メッセージタイプ | `'init'`, `'s'` (state), `'pm'` (player master), `'round_start'`, `'round_end'`, `'chat'` 等 |
| `id` | 自分のID | 初回 `init` 時に付与。 |
| `world` | ワールド情報 | `{ width, height }` (グリッド計算用) |
| `p` / `players` | プレイヤーリスト | 状態更新用配列。 |
| `tm` / `time` | 残り時間 | ゲーム終了までの秒数。 |
| `pc` | 接続数 | ロビー待機含む全接続数。 |
| `tb` | 領地バイナリ | 領地更新差分データ（後述）。 |
| `mm` | ミニマップデータ | `{ tb: { bm: 'Base64Bitmap', sz: Size, cp: Palette } }` |
| `te` / `teams`| チーム統計 | チームごとの占有率、スコア等。 |

### 4.3 領地バイナリフォーマット (`tb`)

帯域削減のため、領地の増減は**リトルエンディアンのカスタムバイナリ**で送信されます。

**構造:**
1. **Additions (追加分):**
   - `Count` (Uint16): 個数
   - **各エントリ (12 bytes):**
     - `x` (Uint16): グリッドX座標
     - `y` (Uint16): グリッドY座標
     - `w` (Uint16): 幅
     - `h` (Uint16): 高さ
     - `sid` (Uint16): 所有者ShortID
     - `r, g, b` (Uint8 x3): 色 (チーム固定色またはプレイヤー色)
     - `padding` (Uint8): パディング
2. **Removals (削除分):**
   - `Count` (Uint16): 個数
   - **各エントリ (4 bytes):**
     - `x` (Uint16): グリッドX座標
     - `y` (Uint16): グリッドY座標

### 4.4 ミニマップ転送仕様 (`mm.tb`)

- **解像度:** 40x40 グリッド。
- **データ形式:** Gzip圧縮(Deflate)されたバイト配列をBase64エンコード。
- **値:** 0=空, 1-255=パレットインデックス。
- **パレット (`cp`):** インデックスに対応するカラーコード(Hex)のマッピング。

## 5. UI & ゲーム仕様

### 5.1 ゲーム画面
- **バーチャルジョイスティック:** タッチ/マウス追従型の操作UI。
- **リーダーボード:**
  - チームモード: 上位2チーム + 自チームを表示。
  - ソロモード: 上位5プレイヤーを表示。
  - 名前リミット: 長い名前は省略表示。
- **スコア表示:**
  - "占領": 占領したマップの割合（%）を表示。
  - 内部的にはRawスコアも保持・計算。
- **チャット:** ニコニコ動画風の流れるコメント表示。
- **キルログ:** 画面左上に誰が誰を倒したかを表示。

### 5.2 結果画面
- 最終的な順位表とマップのスクリーンショットを表示。
- 履歴モーダル: 過去のラウンド詳細、統計グラフ等の閲覧が可能。

### 5.3 チーム仕様
- **固定チーム色:** RED, BLUE, GREEN, YELLOW 等の固定色を使用。
- **初期領地:** チーム参加時に初期領地が割り当てられる場合がある。

## 6. その他・実装メモ

- **キャッシュバスティング:** 全JS/CSSリソース読み込み時に `?v=TIMESTAMP` を付与。
- **SEO最適化:** 適切なメタタグ、h1タグの使用。
- **パフォーマンス:**
  - サーバー: メモリ使用量、イベントループラグ、CPU負荷をAPIで監視可能。
  - 通信: バイナリプロトコルとGzip圧縮で転送量を最小化。
