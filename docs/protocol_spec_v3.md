# MessagePack Protocol Specification v3

本ドキュメントは `game01` プロジェクトの通信プロトコル仕様書の **v3** 版です。

## v2からの主な変更点

- **移動コマンド**: 1バイト角度方式に変更（13B → 1B、**92%削減**）
- **ミニマップ**: ビットマップ形式で圧縮送信（80%削減）
- **変更時のみ送信**: 移動コマンドは方向が変わった時のみ送信
- **統計レポート強化**: 機能別送受信内訳の表示

---

## 共通仕様
- **形式**: MessagePack (msgpack-lite) / バイナリ
- **圧縮**: WebSocket の `perMessageDeflate` (gzip) が適用される場合があります
- **送信間隔**: 状態更新は約150ms間隔（6.7回/秒）

---

## 1. サーバー送信 (Server -> Client)

### 1.1 状態更新 (State Update)
ゲームのメインループで定期的に送信される頻出パケット。  
**AOI (Area Of Interest)** により、各クライアントには視界範囲内のプレイヤーのみが送信されます。

| キー | 型 | 内容 | 備考 |
| :--- | :--- | :--- | :--- |
| `type` | string | 固定値 `"s"` | "state" の短縮 |
| `tm` | int | 残り時間 (秒) | "time" |
| `p` | array | プレイヤーリスト (AOI適用後) | "players" |
| `te` | array | チーム統計 | "teams" (チームごとの人数) |
| `td` | object | 領土**差分**データ | "territory delta" (差分がある時のみ) |
| `tf` | array | 領土**全量**データ | "territory full" (フル同期時のみ) |
| `tv` | int | 領土バージョン | "territory version" |
| `mm` | object | ミニマップ用データ | 3秒に1回送信 (ビットマップ形式) |

#### プレイヤーオブジェクト (`p` 配列の中身)
| キー | 型 | 内容 | 備考 |
| :--- | :--- | :--- | :--- |
| `i` | string | プレイヤーID | "id" |
| `x` | int | X座標 | 整数に丸め |
| `y` | int | Y座標 | 整数に丸め |
| `c` | string | 色コード (Hex) | "color" |
| `n` | string | 名前 | "name" |
| `e` | string | 絵文字 | "emoji" |
| `t` | string | チーム名 | "team" (空文字の場合はソロ) |
| `r` | array | 軌跡 (Trail) | "route/trail", `[[x,y],...]` |
| `s` | int | スコア | "score" |
| `k` | int | キル数 | "kills" |
| `st` | int | 状態 | 1=active, 0=dead, 2=waiting |
| `iv` | int | 無敵残り時間 (秒) | "invulnerable" (0の場合は無敵なし) |

#### ミニマップオブジェクト (`mm`) - v3新形式

| キー | 型 | 内容 | 備考 |
| :--- | :--- | :--- | :--- |
| `tb` | object | テリトリービットマップ | "territory bitmap" |
| `pl` | array | プレイヤー位置リスト | "player list" |

##### `tb` (Territory Bitmap)
| キー | 型 | 内容 | 備考 |
| :--- | :--- | :--- | :--- |
| `bm` | string | Base64 + gzip圧縮されたビットマップ | 80x80=6400バイト→圧縮後200-800バイト |
| `cp` | object | 色パレット (使用中のindex → hex color) | `{"1": "#ff0000", "3": "#0000ff"}` |
| `sz` | int | ビットマップサイズ | 常に80 |

##### `pl` (Player List)
| キー | 型 | 内容 | 備考 |
| :--- | :--- | :--- | :--- |
| `i` | string | プレイヤーID | "id" |
| `x` | int | X座標 | |
| `y` | int | Y座標 | |
| `c` | string | 色コード | "color" |

> **💡 最適化効果**: 従来方式（矩形リスト）比で約 **80%のデータ削減**

---

### 1.2 初期化 (Initialization)
接続確立時に一度だけ送信される **JSON形式** のメッセージ。

| キー | 型 | 内容 | 備考 |
| :--- | :--- | :--- | :--- |
| `type` | string | 固定値 `"init"` | |
| `id` | string | 自分のプレイヤーID | |
| `color` | string | 自分の色コード | |
| `emoji` | string | 自分の絵文字 | |
| `world` | object | `{ width, height }` | ワールドサイズ |
| `mode` | string | `"SOLO"` or `"TEAM"` | 現在のゲームモード |
| `tf` | array | 初期の全領土データ | |
| `tv` | int | 初期の領土バージョン | |
| `obstacles` | array | 障害物リスト | |
| `teams` | array | 現在のチーム統計 | `[{name, count}, ...]` |

---

### 1.3 その他イベント
| type | 内容 | 構造 |
| :--- | :--- | :--- |
| `round_start` | ラウンド開始 | `{ type, mode, obstacles, world }` |
| `round_end` | ラウンド終了 | `{ type, rankings, teamRankings, winner, nextMode, allTeams, totalPlayers }` |
| `player_death` | 死亡通知 | `{ type, id, reason }` |
| `chat` | チャット | `{ type, text, color, name }` |

---

## 2. クライアント送信 (Client -> Server)

### 2.1 操作入力 (Input) - v3新形式 ⚡

**1バイトバイナリ角度方式**: 移動方向を1バイトで送信。

| 値 | 内容 |
| :--- | :--- |
| `0-254` | 移動角度 (0 = 左, 64 = 下, 127 = 右, 191 = 上) |
| `255` | 停止 |

#### 角度の計算方法

```javascript
// クライアント側 (送信)
const angle = Math.atan2(dy, dx);  // -π 〜 π
const normalized = (angle + Math.PI) / (2 * Math.PI);  // 0 〜 1
const byte = Math.round(normalized * 254) % 255;  // 0 〜 254
socket.send(new Uint8Array([byte]));

// サーバー側 (受信)
const normalized = byte / 254;  // 0 〜 1
const angle = normalized * 2 * Math.PI - Math.PI;  // -π 〜 π
p.dx = Math.cos(angle);
p.dy = Math.sin(angle);
```

#### 角度値の目安
| 値 | 方向 |
| :--- | :--- |
| 0 | ← 左 |
| 64 | ↓ 下 |
| 127 | → 右 |
| 191 | ↑ 上 |
| 32 | ↙ 左下 |
| 96 | ↘ 右下 |
| 159 | ↗ 右上 |
| 223 | ↖ 左上 |

#### 送信タイミング
- **方向が変わった時のみ送信**
- **1秒に1回は強制同期**（パケットロス対策）

> **💡 最適化効果**: 
> - v1: `{"type":"input",dx":0.707,...}` (約45バイト)
> - v2: `[0.707,0.707]` (約13バイト)
> - **v3: 1バイト** (約**92%削減**)
> - 変更時のみ送信で更に **60-80%削減**

### 2.2 参加リクエスト (Join) - JSON形式
| キー | 型 | 内容 |
| :--- | :--- | :--- |
| `type` | string | 固定値 `"join"` |
| `name` | string | プレイヤー名 |
| `team` | string | 希望チーム名 (3文字まで) |

### 2.3 チーム更新 (Update Team) - JSON形式
| キー | 型 | 内容 |
| :--- | :--- | :--- |
| `type` | string | 固定値 `"update_team"` |
| `team` | string | 新しい希望チーム名 (3文字まで) |

### 2.4 チャット (Chat) - JSON形式
| キー | 型 | 内容 |
| :--- | :--- | :--- |
| `type` | string | 固定値 `"chat"` |
| `text` | string | チャットメッセージ (50文字まで) |

---

## 3. 最適化機能

### 3.1 AOI (Area Of Interest)
各クライアントには、自分の位置から **2500px** 以内のプレイヤーのみが送信されます。  
これにより、大人数時のデータ量を大幅に削減します。

### 3.2 差分同期
領土データはバージョン管理されており、通常は差分(`td`)のみが送信されます。  
バージョンが50以上離れた場合は、フル同期(`tf`)が行われます。

### 3.3 ミニマップビットマップ (v3)
ミニマップ用データ(`mm`)は **3秒に1回** のみ送信されます。
- テリトリーは80x80ビットマップに圧縮
- gzip + Base64でさらに圧縮
- AOIの影響を受けず、全プレイヤーの位置が含まれます

### 3.4 1バイト角度方式 (v3)
移動コマンドは1バイトの角度値で送信します。
- 精度: 360度 / 255 ≒ 1.4度刻み
- 停止: 255
- 変更時のみ送信 + 1秒ごと強制同期

### 3.5 サーバーループ
サーバーは2つの独立したループで動作します：

| ループ | 間隔 | 処理内容 |
| :--- | :--- | :--- |
| ゲームループ | 50ms (20 FPS) | プレイヤー移動、衝突判定、陣地キャプチャ |
| ブロードキャストループ | 150ms (6.7 FPS) | 状態更新の送信、AOIフィルタリング |

---

## 4. データサンプル

### 4.1 Input (クライアント -> サーバー) - v3
- **形式**: 1バイトバイナリ
- **サイズ**: 1 Byte

```
0x7F  // 127 = 右方向
0xFF  // 255 = 停止
0x00  // 0 = 左方向
```

### 4.2 State Update with Minimap (3秒ごと)
```json
{
  "type": "s",
  "tm": 115,
  "te": [
    { "name": "RED", "count": 3 }
  ],
  "p": [
    {
      "i": "a1b2",
      "x": 1300,
      "y": 920,
      "c": "#ff0000",
      "n": "[RED] Player1",
      "e": "🔥",
      "t": "RED",
      "r": [[1250, 890], [1300, 920]],
      "s": 550,
      "st": 1,
      "iv": 0
    }
  ],
  "mm": {
    "tb": {
      "bm": "eJztwTE...(Base64 gzip圧縮データ)",
      "cp": {"1": "#ff0000", "3": "#0000ff"},
      "sz": 80
    },
    "pl": [
      { "i": "a1b2", "x": 1300, "y": 920, "c": "#ff0000" },
      { "i": "c3d4", "x": 5000, "y": 4500, "c": "#0000ff" }
    ]
  },
  "tv": 126
}
```

---

## 5. バージョン変更点まとめ

| 変更項目 | v1 | v2 | v3 |
| :--- | :--- | :--- | :--- |
| **移動コマンド** | `{type,dx,dy,...}` (45B) | `[dx,dy]` (13B) | **1バイト角度** (1B) |
| **削減率** | - | 70% | **97%** |
| 送信タイミング | 毎フレーム | 毎フレーム | **変更時のみ** |
| ミニマップ | なし | JSON配列 | **ビットマップ圧縮** |
| 色パレット | - | 配列 | **オブジェクト (使用中のみ)** |

---

## 6. 起動オプション

サーバーは以下のコマンドライン引数をサポートします：

```bash
node server.js [options...]
```

| オプション | 説明 |
| :--- | :--- |
| `debug` | デバッグモード。ゲーム時間が無限に |
| `inner_debug` | 内側デバッグ。プレイヤー近くに自陣30x30と敵陣10x10を自動生成 |
| `stage=team` | 強制チーム戦モード。ラウンド終了時もモード変更なし |
| `mugen` | 無限時間モード。制限時間なし |
| `toukei` | 統計モード。ラウンド終了時に転送量統計を出力 |

### 統計出力 (toukei)

ラウンド終了時に以下の形式で出力されます：

1. **整形済みレポート**: 罫線付きの人間可読形式
2. **JSON形式**: `[STATS_JSON]{...}` プレフィックス付きの1行JSON

#### 機能別内訳 (v3で追加)

**送信 (Server → Client)**
- プレイヤーデータ (p)
- テリトリー全量 (tf)
- テリトリー差分 (td)
- ミニマップ (mm)
- チーム統計 (te)
- ベース情報 (type, tm)
- その他

**受信 (Client → Server)**
- 移動入力
- 参加
- チャット
- チーム変更
- その他

---

## 7. 後方互換性

### サーバー側
v3サーバーはv2クライアントからの旧形式 `[dx, dy]` も受け付けます。

```javascript
// 1バイトバイナリ (v3)
if (Buffer.isBuffer(msg) && msg.length === 1) {
    // 新形式処理
}
// JSON配列 (v2)
else if (Array.isArray(data) && data.length === 2) {
    // 旧形式処理
}
```

### クライアント側
v3クライアントはv2サーバーとは互換性がありません（サーバーがバイナリを解釈できないため）。
