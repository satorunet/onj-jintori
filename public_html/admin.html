<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jintori - ç®¡ç†ç”»é¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1e293b;
            --card-bg: #334155;
            --text-color: #f1f5f9;
            --accent: #3b82f6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Yomogi", cursive;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #475569;
            color: white;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
        }

        .tab-btn.active {
            background: var(--accent);
        }

        .content {
            max-width: 1000px;
            margin: 0 auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th,
        td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #475569;
        }

        th {
            background: #475569;
            color: #94a3b8;
        }

        tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h3 {
            margin-bottom: 15px;
            color: #94a3b8;
        }

        .loading {
            text-align: center;
            color: #94a3b8;
            padding: 40px;
        }

        .error {
            text-align: center;
            color: #ef4444;
            padding: 40px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }

        .stat-box .label {
            font-size: 0.85rem;
            color: #94a3b8;
        }
    </style>
</head>

<body>
    <h1>ğŸ® Jintori ç®¡ç†ç”»é¢</h1>

    <div class="tabs">
        <button class="tab-btn" onclick="loadTab('realtime')">ğŸ”´ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </button>
        <button class="tab-btn active" onclick="loadTab('stats')">ğŸ“ˆ ã‚µãƒ¼ãƒãƒ¼è² è·</button>
        <button class="tab-btn" onclick="loadTab('rounds')">ğŸ† ãƒ©ã‚¦ãƒ³ãƒ‰å±¥æ­´</button>
        <button class="tab-btn" onclick="loadTab('players')">ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆ</button>
        <button class="tab-btn" onclick="loadTab('teams')">ğŸ… ãƒãƒ¼ãƒ çµ±è¨ˆ</button>
        <button class="tab-btn" style="background:#ef4444;" onclick="resetData()">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="content" id="content">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <script>
        // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è‡ªå‹•åˆ¤å®š
        // ã‚µãƒ¼ãƒãƒ¼ä¸Š(localhostãªã©)ã«ã‚ã‚‹å ´åˆã¯ç›¸å¯¾ãƒ‘ã‚¹ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯å›ºå®šURL
        const API_BASE = (location.protocol === 'file:') 
            ? 'http://localhost:2053' 
            : ''; 
        // const API_BASE = 'https://zin-new.open2ch.net:2053';
        let currentTab = 'stats';
        let realtimeInterval = null;

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(2) + ' MB';
            return (bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB';
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        async function loadTab(tab) {
            currentTab = tab;

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’åœæ­¢
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
            }

            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', ['realtime', 'stats', 'rounds', 'players', 'teams'][i] === tab);
            });

            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';

            try {
                if (tab === 'realtime') {
                    await loadRealtime();
                    // 5ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
                    realtimeInterval = setInterval(loadRealtime, 5000);

                } else if (tab === 'stats') {
                    const res = await fetch(API_BASE + '/api/server-stats', { credentials: 'include' });
                    const data = await res.json();

                    let html = '<div class="card"><h3>æœ€è¿‘ã®ãƒ©ã‚¦ãƒ³ãƒ‰çµ±è¨ˆ</h3>';

                    // çµ±è¨ˆã‚µãƒãƒª
                    if (data.recent.length > 0) {
                        const latest = data.recent[0];
                        html += '<div class="stat-grid">';
                        html += `<div class="stat-box"><div class="value">${data.recent.length}</div><div class="label">è¨˜éŒ²æ¸ˆã¿ãƒ©ã‚¦ãƒ³ãƒ‰</div></div>`;
                        html += `<div class="stat-box"><div class="value">${latest.cpu_percent}%</div><div class="label">æœ€æ–°CPU</div></div>`;
                        html += `<div class="stat-box"><div class="value">${latest.avg_lag_ms}ms</div><div class="label">æœ€æ–°ãƒ©ã‚°</div></div>`;
                        html += `<div class="stat-box"><div class="value">${latest.active_player_count}</div><div class="label">æœ€æ–°ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</div></div>`;
                        html += `<div class="stat-box"><div class="value">${latest.heap_used_mb || 0} MB</div><div class="label">æœ€æ–°Heap</div></div>`;
                        html += `<div class="stat-box"><div class="value">${latest.rss_mb || 0} MB</div><div class="label">æœ€æ–°RSS</div></div>`;
                        html += '</div>';
                    }

                    html += '<table><thead><tr><th>æ—¥æ™‚</th><th>ãƒ¢ãƒ¼ãƒ‰</th><th>æ™‚é–“</th><th>äººæ•°</th><th>é€ä¿¡é‡</th><th>CPU</th><th>Heap</th><th>ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒª</th><th>ãƒ©ã‚°</th></tr></thead><tbody>';
                    data.recent.forEach(r => {
                        const date = new Date(r.created_at).toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const mb = (r.bytes_sent / 1024 / 1024).toFixed(1);
                        const sysMemPctColor = (r.system_mem_usage_pct || 0) > 80 ? '#ef4444' : (r.system_mem_usage_pct || 0) > 60 ? '#eab308' : '#22c55e';
                        html += `<tr><td>${date}</td><td>${r.mode}</td><td>${r.round_duration_sec}s</td><td>${r.active_player_count}/${r.player_count}</td><td>${mb}MB</td><td>${r.cpu_percent}%</td><td>${r.heap_used_mb || 0}MB</td><td style="color:${sysMemPctColor}">${r.system_mem_usage_pct || 0}%</td><td>${r.avg_lag_ms}ms</td></tr>`;
                    });
                    html += '</tbody></table></div>';

                    // æ—¥åˆ¥ã‚µãƒãƒª
                    if (data.daily && data.daily.length > 0) {
                        html += '<div class="card"><h3>æ—¥åˆ¥ã‚µãƒãƒª</h3>';
                        html += '<table><thead><tr><th>æ—¥ä»˜</th><th>ãƒ©ã‚¦ãƒ³ãƒ‰</th><th>ç·ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th><th>å¹³å‡ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</th><th>ç·é€ä¿¡é‡</th><th>å¹³å‡CPU</th><th>å¹³å‡Heap</th><th>å¹³å‡ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒª</th><th>æœ€å¤§ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒª</th></tr></thead><tbody>';
                        data.daily.forEach(d => {
                            const gb = (d.total_bytes_sent / 1024 / 1024 / 1024).toFixed(2);
                            const avgSysMemColor = (d.avg_sys_mem_pct || 0) > 80 ? '#ef4444' : (d.avg_sys_mem_pct || 0) > 60 ? '#eab308' : '#22c55e';
                            const maxSysMemColor = (d.max_sys_mem_pct || 0) > 80 ? '#ef4444' : (d.max_sys_mem_pct || 0) > 60 ? '#eab308' : '#22c55e';
                            html += `<tr><td>${d.date}</td><td>${d.total_rounds}</td><td>${d.total_players}</td><td>${d.avg_active}</td><td>${gb}GB</td><td>${d.avg_cpu}%</td><td>${d.avg_heap || 0}MB</td><td style="color:${avgSysMemColor}">${d.avg_sys_mem_pct || 0}%</td><td style="color:${maxSysMemColor}">${d.max_sys_mem_pct || 0}%</td></tr>`;
                        });
                        html += '</tbody></table></div>';
                    }
                    content.innerHTML = html;

                } else if (tab === 'rounds') {
                    const res = await fetch(API_BASE + '/api/rounds', { credentials: 'include' });
                    const data = await res.json();
                    let html = '<div class="card"><h3>æœ€è¿‘ã®ãƒ©ã‚¦ãƒ³ãƒ‰</h3>';
                    html += '<table><thead><tr><th>æ—¥æ™‚</th><th>ãƒ¢ãƒ¼ãƒ‰</th><th>äººæ•°</th><th>å„ªå‹è€…</th><th>ã‚¹ã‚³ã‚¢</th></tr></thead><tbody>';
                    data.forEach(r => {
                        const date = new Date(r.played_at).toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        html += `<tr><td>${date}</td><td>${r.mode}</td><td>${r.player_count}</td><td>${r.winner || '-'}</td><td>${r.winner_score || '-'}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                    content.innerHTML = html;

                } else if (tab === 'players') {
                    const res = await fetch(API_BASE + '/api/player-stats', { credentials: 'include' });
                    const data = await res.json();
                    let html = '<div class="card"><h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç´¯è¨ˆçµ±è¨ˆ</h3>';
                    html += '<table><thead><tr><th>#</th><th>åå‰</th><th>è©¦åˆæ•°</th><th>1ä½</th><th>ç´¯è¨ˆã‚¹ã‚³ã‚¢</th><th>ã‚­ãƒ«</th><th>å¹³å‡</th><th>æœ€é«˜</th></tr></thead><tbody>';
                    data.forEach((p, i) => {
                        html += `<tr><td>${i + 1}</td><td>${p.player_name}</td><td>${p.total_games}</td><td>${p.wins}</td><td>${p.total_score}</td><td>${p.total_kills}</td><td>${p.avg_score}</td><td>${p.best_score}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                    content.innerHTML = html;

                } else if (tab === 'teams') {
                    const res = await fetch(API_BASE + '/api/team-stats', { credentials: 'include' });
                    const data = await res.json();
                    let html = '<div class="card"><h3>ãƒãƒ¼ãƒ ç´¯è¨ˆçµ±è¨ˆ</h3>';
                    html += '<table><thead><tr><th>#</th><th>ãƒãƒ¼ãƒ </th><th>è©¦åˆæ•°</th><th>1ä½</th><th>ç´¯è¨ˆã‚¹ã‚³ã‚¢</th><th>ã‚­ãƒ«</th><th>å¹³å‡</th><th>æœ€é«˜</th></tr></thead><tbody>';
                    data.forEach((t, i) => {
                        html += `<tr><td>${i + 1}</td><td>${t.team_name}</td><td>${t.total_games}</td><td>${t.wins}</td><td>${t.total_score}</td><td>${t.total_kills}</td><td>${t.avg_score}</td><td>${t.best_score}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                    content.innerHTML = html;
                }
            } catch (e) {
                content.innerHTML = '<div class="error">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div>';
            }
        }

        async function loadRealtime() {
            try {
                const res = await fetch(API_BASE + '/api/server-realtime', { credentials: 'include' });
                const data = await res.json();
                const content = document.getElementById('content');

                const uptimeStr = `${Math.floor(data.uptime / 3600)}æ™‚é–“${Math.floor((data.uptime % 3600) / 60)}åˆ†`;
                const roundStatus = data.roundActive ? `ğŸŸ¢ é€²è¡Œä¸­ (æ®‹ã‚Š ${formatTime(data.timeRemaining)})` : 'ğŸ”´ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«';

                let html = `
                <div class="card">
                    <h3>ğŸ”´ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° <span style="font-size:0.8rem; color:#94a3b8;">(5ç§’ã”ã¨è‡ªå‹•æ›´æ–°)</span></h3>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="value">${data.players.active}/${data.players.total}</div>
                            <div class="label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/æ¥ç¶š</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${data.mode}</div>
                            <div class="label">ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${uptimeStr}</div>
                            <div class="label">ç¨¼åƒæ™‚é–“</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" style="font-size:1rem;">${roundStatus}</div>
                            <div class="label">ãƒ©ã‚¦ãƒ³ãƒ‰çŠ¶æ…‹</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ§  ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</h3>
                    <div class="stat-grid">
                        <div class="stat-box" style="grid-column: span 2;">
                            <div class="value" style="color: ${data.memory.systemUsagePercent > 80 ? '#ef4444' : data.memory.systemUsagePercent > 60 ? '#eab308' : '#22c55e'}; font-size: 2rem;">
                                ${data.memory.systemUsagePercent}%
                            </div>
                            <div class="label">ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ (${Math.round(data.memory.systemUsedMB)} / ${Math.round(data.memory.systemTotalMB)} MB)</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${data.memory.heapUsedMB} MB</div>
                            <div class="label">Heap Used</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${data.memory.heapTotalMB} MB</div>
                            <div class="label">Heap Total</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${data.memory.rssMB} MB</div>
                            <div class="label">RSS (Node.js)</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${Math.round(data.memory.systemFreeMB)} MB</div>
                            <div class="label">ç©ºããƒ¡ãƒ¢ãƒª</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ’» CPUè² è·</h3>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="value">${data.cpu.loadAvg1m.toFixed(2)}</div>
                            <div class="label">Load Avg (1m)</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${data.cpu.loadAvg5m.toFixed(2)}</div>
                            <div class="label">Load Avg (5m)</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${data.cpu.loadAvg15m.toFixed(2)}</div>
                            <div class="label">Load Avg (15m)</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ—ºï¸ ã‚²ãƒ¼ãƒ çŠ¶æ…‹</h3>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="value">${data.territories.count}</div>
                            <div class="label">ãƒ†ãƒªãƒˆãƒªãƒ¼æ•°</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${data.territories.version}</div>
                            <div class="label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${formatBytes(data.bandwidth.totalBytesSent)}</div>
                            <div class="label">ç´¯è¨ˆé€ä¿¡</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${formatBytes(data.bandwidth.totalBytesReceived)}</div>
                            <div class="label">ç´¯è¨ˆå—ä¿¡</div>
                        </div>
                    </div>
                </div>
                `;

                content.innerHTML = html;
            } catch (e) {
                if (currentTab === 'realtime') {
                    document.getElementById('content').innerHTML = '<div class="error">æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + e.message + '</div>';
                }
            }
        }

        async function resetData() {
            if (!confirm('ã€è­¦å‘Šã€‘\nãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¨å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ï¼ˆçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ï¼‰ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            if (!confirm('å¿µã®ãŸã‚ã‚‚ã†ä¸€åº¦èãã¾ã™ã€‚\næœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const res = await fetch(API_BASE + '/api/admin/reset-rankings', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('ãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');
                    loadTab(currentTab); // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (e) {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        loadTab('stats');
    </script>
</body>

</html>